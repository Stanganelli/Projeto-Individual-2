<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedConnect | Gerenciar Usuários</title>

    <link rel="stylesheet" href="css/dashboard.css">
    <!-- <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script> -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/validacoesUsuario.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>

    <div class="principal">
        <div class="sidebar">
            <div class="content-sidebar">
                <div class="logo-sidebar">
                    <img src="../Img/logo horizontal sem fundo.png" alt="">
                </div>

                <div class="options-sidebar">
                    <div class="opt">
                        <img src="../Img/icons8-gráfico-combinado-30.png" alt="">
                        <a href="dashboard.html">Dashboard Geral</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-robô-48.png" alt="">
                        <a href="dash-robo.html">Dashboard Rôbos</a>
                    </div>

                    <div class="opt" id="aqui">
                        <img src="../Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="dash-gerenciar-users.html">Gerenciar Usuários</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="perfil.html">Perfil</a>
                    </div>

                    <div class="opt">
                        <img src="Img/icons8-hospital-50.png" id="diminuir" alt="">
                        <a href="cadastrar-cirurgia.html">Gerenciar Cirurgia</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-assistente-48.png" alt="">
                        <a href="dash-suporte.html">Suporte</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-alerta-30.png" alt="">
                        <a href="#">Chamado</a>
                    </div>
                </div>

                <div class="quit-button">
                    <div class="opt">
                        <img src="../Img/icons8-sair-30.png" alt="">
                        <a href="index.html">Log Out</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="content" style="height: fit-content;">
            <div class="header-content">
                <div class="navbar-header" style="height: 10vh;">
                    <h3>Gerenciar Usuarios</h3>
                    <p>Olá, <span style="font-weight: bolder;" id="b_usuario"></span></p>
                </div>
            </div>

            <div class="container-cirurgia" style="height: fit-content;">

                <div class="content-listagem">
                    <div class="listagem" id="listagem">
                        <h3 style="margin-top: 3%;">Usuários Criados</h3>

                        <!-- <div class="cirurgia">
                            <div class="item-cirurgia">
                                <b>Nome</b>
                                <span id="nome_medico">Gabriel Boos</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Email</b>
                                <span id="data_inicio">gabriel.boos@hotmail.com</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>CPF</b>
                                <span id="horario_inicio">523.525.322.123</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Telefone</b>
                                <span id="duracao_minutos">11929458258</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Senha</b>
                                <span id="duracao_minutos">5152ttt2</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Cargo</b>
                                <span id="duracao_minutos">Admin</span>
                            </div>
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lápis-20.png" alt="">
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lixo-20.png" alt="">
                        </div> -->
                    </div>
                </div>


                <div class="drop-cadastrar">
                    <h3>
                        Cadastrar Usuário
                        <img src="./Img/icons8-divisa-circulada-à-direita-24.png" alt="" onclick="dropCadastro()">
                    </h3>
                    <div style="display: none;" class="form-cirurgia" id="form_cirurgia">
                        <div class="content-form-cirurgia">
                            <div class="div1">
                                <div class="input-cirurgia">
                                    Nome
                                    <input type="text" id="input_nome">
                                </div>
                                <div class="input-cirurgia">
                                    Email
                                    <input type="text" id="input_email">
                                </div>
                                <div class="input-cirurgia">
                                    <select id="cargoSelect" name="empresa">
                                        <option>Cargo</option>
                                    </select>
                                </div>
                                <div class="input-cirurgia">
                                    CPF
                                    <input type="text" id="cpf_input">
                                </div>
                            </div>
                            <div class="div1">
                                <div class="input-cirurgia">
                                    Telefone
                                    <input type="Number" id="telefone_input">
                                </div>
                                <div class="input-cirurgia">
                                    Senha
                                    <input type="password" id="input_senha">
                                </div>
                                <div class="input-cirurgia">
                                    Hospital
                                    <input type="text" disabled id="input_hospital">
                                </div>
                            </div>
                            <div class="div1" style="display: flex; justify-content: start;">
                                <button style="background-color: rgb(50, 125, 50); margin-right: 3vw;"
                                    onclick="cadastrar()">Cadastrar</button>
                                <button id="mensagem_erro_cadastro">Erro</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="drop-cadastrar" style="margin-top: 2%; margin-bottom: 2%;">
                <h3>
                    Editar Usuário
                    <img src="./Img/icons8-divisa-circulada-à-direita-24.png" alt="" onclick="dropEditar()">
                </h3>
                <div style="display: none;" class="form-cirurgia" id="form_cirurgia2">
                    <div class="content-form-cirurgia">
                        <div class="div1">
                            <div class="input-cirurgia">
                                Nome
                                <input type="text" id="nome_input_edit">
                            </div>
                            <div class="input-cirurgia">
                                Email
                                <input type="text" id="email_input_edit">
                            </div>
                            <div class="input-cirurgia">
                                <select id="cargoSelectEdit" name="empresa">
                                    <option>Cargo</option>
                                </select>
                            </div>
                            <div class="input-cirurgia">
                                CPF
                                <input type="text" id="cpf_input_edit" disabled>
                            </div>
                        </div>
                        <div class="div1">
                            <div class="input-cirurgia">
                                Telefone
                                <input type="Number" id="telefone_input_edit">
                            </div>
                            <div class="input-cirurgia">
                                Senha
                                <input type="password" id="senha_input_edit">
                            </div>
                            <div class="input-cirurgia">
                                Hospital
                                <input type="text" id="hospital_input_edit" disabled>
                            </div>
                        </div>
                        <div class="div1" style="display: flex; justify-content: start;">
                            <button style="background-color: rgb(50, 125, 50); margin-right: 3vw;"
                                onclick="editar()">Editar</button>
                            <button id="mensagem_erro_cadastro">Erro</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>
    </div>




</body>

</html>

<script>

    var drop = 0
    function dropCadastro() {
        if (drop == 0) {
            form_cirurgia.style.display = "flex"
            drop = 1
        } else {
            form_cirurgia.style.display = "none"
            drop = 0
        }

    }

    var drop2 = 0
    function dropEditar() {
        if (drop2 == 0) {
            form_cirurgia2.style.display = "flex"
            drop2 = 1
        } else {
            form_cirurgia2.style.display = "none"
            drop2 = 0
        }

    }



    cargo = sessionStorage.CARGO_USUARIO

    if (cargo !== "Atendente" && cargo !== "Admin") {
        voltarHome()
    }

    function voltarHome() {
        window.location = '../index.html'
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    input_hospital.value = sessionStorage.NOME_HOSPITAL;
    hospital_input_edit.value = sessionStorage.NOME_HOSPITAL;

    var cargos;
    fetch("/cargo/listar", {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao fazer a solicitação GET');
            }
            return response.json();
        }).then(data => {

            console.log(data)

            cargos = data;

            var selectElement = document.getElementById('cargoSelect');

            // Itera sobre o array de empresas e cria as opções do select
            for (let i = 0; i < cargos.length; i++) {
                const cargo = cargos[i];

                const optionElement = document.createElement('option');
                optionElement.value = cargo.idEscalonamento;
                optionElement.text = cargo.cargo;
                selectElement.appendChild(optionElement);
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    var usuarios;
    fetch("/usuarios/listar", {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao fazer a solicitação GET');
            }
            return response.json();
        }).then(data => {

            console.log(data)

            usuarios = data;


            for (let i = 0; i < usuarios.length; i++) {
                const usuario = usuarios[i];

                listagem.innerHTML += `<div class="cirurgia">
                            <div class="item-cirurgia">
                                <b>Nome</b>
                                <span id="nome_medico">${usuario.nome}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Email</b>
                                <span id="data_inicio">${usuario.email}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>CPF</b>
                                <span id="horario_inicio">${usuario.cpf}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Telefone</b>
                                <span id="duracao_minutos">${usuario.telefone}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Senha</b>
                                <span id="duracao_minutos">${usuario.senha}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Cargo</b>
                                <span id="duracao_minutos">${usuario.cargo}</span>
                            </div>
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lápis-20.png" alt="" onclick="pegarDadosEdicao('${usuario.nome}', '${usuario.email}', '${usuario.cpf}', '${usuario.telefone}', '${usuario.senha}','${usuario.cargo}', '${usuario.idCargo}', '${usuario.idUsuario}')">
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lixo-20.png" alt="" onclick="deletar(${usuario.idUsuario})">
                        </div>`
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    function cadastrar() {
        var nome = input_nome.value;
        var email = input_email.value;
        var cpf = cpf_input.value;
        var telefone = telefone_input.value;
        var senha = input_senha.value
        var cargo = cargoSelect.value
        var hospital = sessionStorage.ID_HOSPITAL;
        mensagem_erro = document.getElementById("mensagem_erro_cadastro")

        
        if (nome == "" || email == "" || cpf == "" || telefone == "" || senha == "" || cargo == "Cargo" || hospital == "") {
            mensagem_erro.innerHTML = "Todos os campos precisam ser preenchidos"
            mensagem_erro.style.display = "block"
            limparMensagem()
        } else if (email.indexOf("@") < 0) {
            mensagem_erro.innerHTML = "Email está no formato inválido"
            mensagem_erro.style.display = "block"

            limparMensagem()
        } else if (senha.length < 6) {
            mensagem_erro.innerHTML = "A senha precisa ter 6 dígitos"
            mensagem_erro.style.display = "block"

            limparMensagem()
        }
        else {
            fetch("/usuarios/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nomeServer: nome,
                    emailServer: email,
                    cpfServer: cpf,
                    telefoneServer: telefone,
                    senhaServer: senha,
                    cargoServer: cargo,
                    hospitalServer: hospital
                })
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO entrar()!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json))


                        mensagem_erro.style = "background-color: green;"
                        mensagem_erro.innerHTML = "Usuário cadastrado com sucesso"
                        mensagem_erro.style.display = "block"

                        setTimeout(function () {
                            location.reload();
                        }, 1000); // 

                    })
                } else {

                }

            }).catch(function (erro) {
                console.log(erro);

            })
        }
    }

    function pegarDadosEdicao(nome, email, cpf, telefone, senha, cargo, idCargo, idUsuario) {
        var hospital = sessionStorage.ID_HOSPITAL;
        dropEditar()
        nome_input_edit.value = nome
        email_input_edit.value = email
        cpf_input_edit.value = cpf
        telefone_input_edit.value = telefone
        senha_input_edit.value = senha
        sessionStorage.idUsuarioEditado = idUsuario


        fetch("/cargo/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao fazer a solicitação GET');
                }
                return response.json();
            }).then(data => {

                console.log(data)

                cargos = data;

                var selectElement = document.getElementById('cargoSelectEdit');

                while (selectElement.options.length > 0) {
                    selectElement.remove(0);
                }

                // Itera sobre o array de empresas e cria as opções do select
                for (let i = 0; i < cargos.length; i++) {
                    const cargoAtual = cargos[i];

                    const optionElement = document.createElement('option');
                    optionElement.value = cargoAtual.idEscalonamento;
                    optionElement.text = cargoAtual.cargo;
                    selectElement.appendChild(optionElement);
                    if (optionElement.text == cargo) {
                        selectElement.value = optionElement.value
                    }
                }


            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function editar(){
        idUsuario = sessionStorage.idUsuarioEditado;
        nome = nome_input_edit.value;
        email = email_input_edit.value; 
        idCargo = cargoSelectEdit.value;
        telefone = telefone_input_edit.value; 
        senha = senha_input_edit.value;
        
        fetch(`/usuarios/editar`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                cargoServer: idCargo,
                telefoneServer: telefone,
                senhaServer: senha,
                idUsuarioServer: idUsuario
            })
        })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO entrar()!")

                if (resposta.ok) {
                    console.log(resposta);

                
                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));
                        setTimeout(function () {
                            location.reload();
                        }, 1000); // 
                    
                    });

                }
            }).catch(function (erro) {
                console.log(erro);
            })
    }

    function deletar(idUsuario) {
        fetch(`/usuarios/deletar`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                idServer: idUsuario,
            })
        })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO entrar()!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));
                        setTimeout(function () {
                            location.reload();
                        }, 1000); // 
                        // funcionarios = json

                        // tabela = document.getElementById("tabela-funcionario")

                        // // Itera sobre o array de empresas e cria as opções do select
                        // for (let i = 0; i < funcionarios.length; i++) {
                        //     const funcionario = funcionarios[i];
                        //     const email = funcionario.email;
                        //     const cargo = funcionario.cargo;
                        //     const idAssociado = funcionario.idAssociado;

                        //     var novaLinha = tabela.insertRow();
                        //     novaLinha.id = idAssociado // Insere uma nova linha
                        //     var celula1 = novaLinha.insertCell(0); // Insere uma célula na posição 0
                        //     var celula2 = novaLinha.insertCell(1);
                        //     var celula3 = novaLinha.insertCell(2)
                        //     celula1.innerHTML = `${email}`;
                        //     celula2.innerHTML = `${cargo}`;
                        //     celula3.innerHTML = `<img src="Img/excluir.png" onclick="remover(idAssociado)" alt="Excluir">`
                        // }
                    });

                }
            }).catch(function (erro) {
                console.log(erro);
            })
    }


    function limparMensagem() {
        setTimeout(() => {
            document.getElementById("mensagem_erro_cadastro").style.display = "none"
        }, 3000)
    }

</script>
<script src="js/validacoesCadastro.js"></script>