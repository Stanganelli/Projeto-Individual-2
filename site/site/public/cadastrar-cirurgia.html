<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/icon/favicon2.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedConnect | Cadastrar Cirurgia</title>

    <link rel="stylesheet" href="css/dashboard.css">
    <!-- <script src="../js/sessao.js"></script>
    <script src="./../js/alerta.js"></script> -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<!-- <body onload=" atualizarFeed()"> -->

<body>

    <div class="principal">
        <div class="sidebar">
            <div class="content-sidebar">
                <div class="logo-sidebar">
                    <img src="../Img/logo horizontal sem fundo.png" alt="">
                </div>

                <div class="options-sidebar">
                    <div class="opt">
                        <img src="../Img/icons8-gráfico-combinado-30.png" alt="">
                        <a href="dashboard.html">Dashboard Geral</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-robô-48.png" alt="">
                        <a href="dash-robo.html">Dashboard Rôbos</a>
                    </div>

                    <div class="opt" id="gerenciar-usuarios">
                        <img src="../Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="dash-gerenciar-users.html">Gerenciar Usuários</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-usuário-30.png" id="diminuir" alt="">
                        <a href="perfil.html">Perfil</a>
                    </div>

                    <div class="opt" id="aqui">
                        <img src="Img/icons8-hospital-50.png" id="diminuir" alt="">
                        <a href="cadastrar-cirurgia.html">Gerenciar Cirurgia</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-assistente-48.png" alt="">
                        <a href="dash-suporte.html">Suporte</a>
                    </div>

                    <div class="opt">
                        <img src="../Img/icons8-alerta-30.png" alt="">
                        <a href="#">Chamado</a>
                    </div>
                </div>

                <div class="quit-button">
                    <div class="opt">
                        <img src="../Img/icons8-sair-30.png" alt="">
                        <a href="index.html">Log Out</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="content" style="height: fit-content;">
            <div class="header-content">
                <div class="navbar-header" style="height: 10vh;">
                    <h3>Gerenciar Cirurgias</h3>
                    <p>Olá, <span style="font-weight: bolder;" id="b_usuario"></span></p>
                </div>
            </div>

            <div class="container-cirurgia" style="height: fit-content;">

                <div class="content-listagem">
                    <div class="listagem" id="listagem">
                        <h3 style="margin-top: 3%;">Cirurgias Recentes</h3>
                        <!--     
                        <div class="cirurgia">
                            <div class="item-cirurgia">
                                <b>Médico</b>
                                <span id="nome_medico">Gabriel Boos</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Data Início</b>
                                <span id="data_inicio">24/01/2000</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Horário Início</b>
                                <span id="horario_inicio">21:00:02</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Duração Min.</b>
                                <span id="duracao_minutos">123m</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Paciente</b>
                                <span id="nome_paciente">Bianca Reis</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Sala</b>
                                <span id="sala_cirurgia">3</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Categoria</b>
                                <span id="categoria_cirurgia">Neurologia</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Risco</b>
                                <span id="risco_cirurgia">5</span>
                            </div>
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lápis-20.png" alt="">
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lixo-20.png" alt="">
                        </div>
     -->
                    </div>
                </div>


                <div class="drop-cadastrar">
                    <h3>
                        Cadastrar Cirurgia
                        <img src="./Img/icons8-divisa-circulada-à-direita-24.png" alt="" onclick="dropCadastro()">
                    </h3>
                    <div style="display: none;" class="form-cirurgia" id="form_cirurgia">
                        <div class="content-form-cirurgia">
                            <div class="div1">
                                <div class="input-cirurgia">
                                    Nome do médico
                                    <input type="text" id="input_nome_medico">
                                </div>
                                <div class="input-cirurgia">
                                    Data de início
                                    <input type="text" id="input_data_inicio">
                                </div>
                                <div class="input-cirurgia">
                                    Horário de início
                                    <input type="text" id="input_horario_inicio">
                                </div>
                                <div class="input-cirurgia">
                                    Duração esperada em minutos
                                    <input type="number" id="input_duracao">
                                </div>

                            </div>
                            <div class="div1">
                                <div class="input-cirurgia">
                                    Nome do paciente
                                    <input type="text" id="input_nome_paciente">
                                </div>
                                <div class="input-cirurgia">
                                    Sala de cirurgia
                                    <select name="" id="select_sala_cadastro">
                                        <option value="">Sala</option>
                                    </select>
                                </div>
                                <div class="input-cirurgia">
                                    Categoria Cirúrgica
                                    <select name="" id="input_categoria">
                                        <option value="Cardiologia">Cardiologia</option>
                                        <option value="Cardiologia">Neurologia</option>
                                        <option value="Cardiologia">Ortopedia</option>
                                        <option value="Cardiologia">Ginecologia</option>
                                        <option value="Cardiologia">Geral</option>
                                        <option value="Cardiologia">Epigástrica</option>
                                        <option value="Cardiologia">Oftalmologia</option>
                                        <option value="Cardiologia">Otorrinolaringologia</option>
                                        <option value="Cardiologia">Pediátrica</option>
                                        <option value="Cardiologia">Plástica</option>
                                        <option value="Cardiologia">Proctologia</option>
                                        <option value="Cardiologia">Vascular</option>
                                        <option value="Cardiologia">Urologia</option>
                                    </select>

                                </div>
                                <div class="input-cirurgia">
                                    Risco Cirúrgico
                                    <input type="range" min="1" max="5" id="input_risco">
                                </div>
                            </div>
                            <div class="div1">
                                <button onclick="cadastrar()"
                                    style="background-color: rgb(50, 125, 50);">Cadastrar</button>
                                <button id="mensagem_erro_cadastro">Erro</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="drop-cadastrar" style="margin-top: 2%; margin-bottom: 2%;">
                    <h3>
                        Editar Cirurgia
                        <img src="./Img/icons8-divisa-circulada-à-direita-24.png" alt="" onclick="dropEditar()">
                    </h3>
                    <div style="display: none;" class="form-cirurgia" id="form_cirurgia2">
                        <div class="content-form-cirurgia">
                            <div class="div1">
                                <div class="input-cirurgia">
                                    Nome do médico
                                    <input type="text" id="input_nome_medico_edit">
                                </div>
                                <div class="input-cirurgia">
                                    Data de início
                                    <input type="text" id="input_data_inicio_edit">
                                </div>
                                <div class="input-cirurgia">
                                    Horário de início
                                    <input type="text" id="input_horario_inicio_edit">
                                </div>
                                <div class="input-cirurgia">
                                    Duração esperada em minutos
                                    <input type="number" id="input_duracao_esperada_edit">
                                </div>

                            </div>
                            <div class="div1">
                                <div class="input-cirurgia">
                                    Nome do paciente
                                    <input type="text" id="input_nome_paciente_edit">
                                </div>
                                <div class="input-cirurgia">
                                    Sala de cirurgia
                                    <select itemid="sala_cirurgia_select" name="" id="select_sala_edit"></select>
                                </div>
                                <div class="input-cirurgia">
                                    Categoria Cirúrgica
                                    <select id="select_categoria_edit" name="" id="">
                                        <option value="Cardiologia">Cardiologia</option>
                                        <option value="Neurologia">Neurologia</option>
                                        <option value="Ortopedia">Ortopedia</option>
                                        <option value="Ginecologia">Ginecologia</option>
                                        <option value="Geral">Geral</option>
                                        <option value="Epigástrica">Epigástrica</option>
                                        <option value="Oftalmologia">Oftalmologia</option>
                                        <option value="Otorrinolaringologia">Otorrinolaringologia</option>
                                        <option value="Pediátrica">Pediátrica</option>
                                        <option value="Plástica">Plástica</option>
                                        <option value="Proctologia">Proctologia</option>
                                        <option value="Vascular">Vascular</option>
                                        <option value="Urologia">Urologia</option>
                                    </select>

                                </div>
                                <div class="input-cirurgia">
                                    Risco Cirúrgico
                                    <input id="input_risco_edit" type="range" min="1" max="5">
                                </div>
                            </div>
                            <div class="div1">
                                <button onclick="editar()" style="background-color: rgb(193, 95, 46);">Editar</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>




</body>

</html>

<script>

    var drop = 0
    function dropCadastro() {
        if (drop == 0) {
            form_cirurgia.style.display = "flex"
            drop = 1
        } else {
            form_cirurgia.style.display = "none"
            drop = 0
        }

    }

    var drop2 = 0
    function dropEditar() {
        if (drop2 == 0) {
            form_cirurgia2.style.display = "flex"
            drop2 = 1
        } else {
            form_cirurgia2.style.display = "none"
            drop2 = 0
        }

    }


    cargo = sessionStorage.CARGO_USUARIO

    gerenciarUsuarios = document.getElementById("gerenciar-usuarios")
    console.log(gerenciarUsuarios)

    // if (cargo !== "Atendente") {
    //     window.location = "dashboard.html"
    // }

    if (cargo !== "Admin") {
        gerenciarUsuarios.style = 'display: none'
    }

    function voltarHome() {
        window.location = '../index.html'
    }

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    idCirurgia = sessionStorage.idUsuarioEditado;

    var id = 1

    // window.onload = exibirComponentes(id);

    var salas;
    fetch("/sala/listar", {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao fazer a solicitação GET');
            }
            return response.json();
        }).then(data => {

            console.log(data)

            salas = data;

            var selectElement = document.getElementById('select_sala_cadastro');

            // Itera sobre o array de empresas e cria as opções do select
            for (let i = 0; i < salas.length; i++) {
                const sala = salas[i];

                const optionElement = document.createElement('option');
                optionElement.value = sala.idSala;
                optionElement.text = sala.numero;
                selectElement.appendChild(optionElement);
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    var cirurgia;
    fetch("/cirurgia/listar", {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao fazer a solicitação GET');
            }
            return response.json();
        }).then(data => {

            console.log(data)

            cirurgias = data;


            for (let i = 0; i < cirurgias.length; i++) {
                const c = cirurgias[i];

                listagem.innerHTML += `<div class="cirurgia">
                            <div class="item-cirurgia">
                                <b>Médico</b>
                                <span id="nome_medico">${c.nomeMedico}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Dt. Início</b>
                                <span id="data_inicio">${c.dataInicio}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Horário. Início</b>
                                <span id="horario_inicio">${c.dataHorario}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Duração min.</b>
                                <span id="duracao_minutos">${c.duracao}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Paciente</b>
                                <span id="nome_paciente">${c.nomePaciente}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Sala</b>
                                <span id="sala">${c.sala}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Categoria</b>
                                <span id="sala">${c.tipo}</span>
                            </div>
                            <div class="item-cirurgia">
                                <b>Risco</b>
                                <span id="sala">${c.fkCategoria}</span>
                            </div>
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lápis-20.png" alt="" onclick="pegarDadosEdicao('${c.nomeMedico}', '${c.dataInicio}', '${c.dataHorario}', '${c.duracao}', '${c.nomePaciente}','${c.sala}','${c.tipo}','${c.fkCategoria}', '${c.idCirurgia}')">
                            <img style="height: 4vh; width: auto;" src="./Img/icons8-lixo-20.png" alt="" onclick="deletar(${c.idCirurgia})">
                        </div>`
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });


    function cadastrar() {
        var nome_medico = input_nome_medico.value;
        var data_inicio = input_data_inicio.value;
        var horario_inicio = input_horario_inicio.value;
        var duracao = input_duracao.value;
        var nome_paciente = input_nome_paciente.value
        var sala = select_sala_cadastro.value
        var categoria = input_categoria.value
        var risco = input_risco.value


        var hospital = sessionStorage.ID_HOSPITAL;

        console.log(cargo)
        if (nome_medico == "" || data_inicio == "" || horario_inicio == "" || duracao == "" || nome_paciente == "" || sala == "" || categoria == "" || risco == "") {
            mensagem_erro_cadastro.innerHTML = "Todos os campos precisam ser preenchidos"
            mensagem_erro_cadastro.style.display = "block"
            limparMensagem()
        }
        else {
            fetch(`/sala/robo/${sala}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao fazer a solicitação GET');
                    }
                    return response.json();
                }).then(data => {

                    console.log(data)

                    fkRoboCirurgia = data[0].fkRoboSala;

                    fetch("/cirurgia/cadastrar", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            nome_medicoServer: nome_medico,
                            data_inicioServer: data_inicio,
                            horario_inicioServer: horario_inicio,
                            duracaoServer: duracao,
                            nome_pacienteServer: nome_paciente,
                            fkRoboCirurgiaServer: fkRoboCirurgia,
                            categoriaServer: categoria,
                            riscoServer: risco
                        })
                    }).then(function (resposta) {
                        console.log("ESTOU NO THEN DO entrar()!")

                        if (resposta.ok) {
                            console.log(resposta);

                            resposta.json().then(json => {
                                console.log(json);
                                console.log(JSON.stringify(json))


                                mensagem_erro_cadastro.style = "background-color: green;"
                                mensagem_erro_cadastro.innerHTML = "Cirurgia cadastrado com sucesso"
                                mensagem_erro_cadastro.style.display = "block"

                                setTimeout(function () {
                                    location.reload();
                                }, 1000); // 

                            })
                        } else {

                        }

                    }).catch(function (erro) {
                        console.log(erro);

                    })
                }).catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });


        }
    }

    function pegarDadosEdicao(nome_medico, data_inicio, horario_inicio, duracao, nome_paciente, sala, categoria, risco, idCirurgia) {

        var hospital = sessionStorage.ID_HOSPITAL;
        dropEditar();
        input_nome_medico_edit.value = nome_medico;
        input_data_inicio_edit.value = data_inicio;
        input_horario_inicio_edit.value = horario_inicio;
        input_duracao_esperada_edit.value = duracao;
        input_nome_paciente_edit.value = nome_paciente;
        select_categoria_edit.value = categoria;
        input_risco_edit.value = risco;

        sessionStorage.idCirurgiaEditado = idCirurgia;

        fetch("/sala/listar", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao fazer a solicitação GET');
                }
                return response.json();
            }).then(data => {

                console.log(data)

                salas = data;

                var selectElement = document.getElementById('select_sala_edit');

                while (selectElement.options.length > 0) {
                    selectElement.remove(0);
                }

                // Itera sobre o array de empresas e cria as opções do select
                for (let i = 0; i < salas.length; i++) {
                    const salaPercorrida = salas[i];

                    const optionElement = document.createElement('option');
                    optionElement.value = salaPercorrida.idSala;
                    optionElement.text = salaPercorrida.numero;
                    selectElement.appendChild(optionElement);
                    if (optionElement.text == sala) {
                        selectElement.value = optionElement.value
                    }
                }

            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }


    function editar() {
        //idUsuario = sessionStorage.idUsuarioEditado;
        nome_medico = input_nome_medico_edit.value;
        data_inicio = input_data_inicio_edit.value;
        horario_inicio = input_horario_inicio_edit.value;
        duracao = input_duracao_esperada_edit.value;
        nome_paciente = input_nome_paciente_edit.value;
        sala = select_sala_edit.value;
        categoria = select_categoria_edit.value;
        risco = input_risco_edit.value;


        fetch(`/sala/robo/${sala}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao fazer a solicitação GET');
                }
                return response.json();
            }).then(data => {

                console.log(data)

                fkRoboCirurgia = data[0].fkRoboSala;
                idCirurgia = sessionStorage.idCirurgiaEditado;

                fetch(`/cirurgia/editar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nome_medicoServer: nome_medico,
                        data_inicioServer: data_inicio,
                        horario_inicioServer: horario_inicio,
                        duracaoServer: duracao,
                        nome_pacienteServer: nome_paciente,
                        fkRoboCirurgiaServer: fkRoboCirurgia,
                        categoriaServer: categoria,
                        riscoServer: risco,
                        cirurgiaServer: idCirurgia
                    })
                })
                    .then(function (resposta) {
                        console.log("ESTOU NO THEN DO entrar()!")

                        if (resposta.ok) {
                            console.log(resposta);


                            resposta.json().then(json => {
                                console.log(json);
                                console.log(JSON.stringify(json));
                                setTimeout(function () {
                                    location.reload();
                                }, 1000); // 

                            });

                        }
                    }).catch(function (erro) {
                        console.log(erro);
                    })
            }).catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function deletar(idCirurgia) {
        fetch(`/cirurgia/deletar`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                idCirurgiaServer: idCirurgia,
            })
        })
            .then(function (resposta) {
                console.log("ESTOU NO THEN DO entrar()!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));
                        setTimeout(function () {
                            location.reload();
                        }, 1000); // 
                       
                    });

                }
            }).catch(function (erro) {
                console.log(erro);
            })
    }

</script>